<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <!-- Include the CesiumJS JavaScript and CSS files -->
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.133/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.133/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
</head>
<body>
  <div id="cesiumContainer"></div>
  <script type="module">

    // Add CitiBike stations as billboards
    async function loadCitiBikeStations(viewer) {
    try {
        // Station metadata
        const infoUrl = "https://gbfs.citibikenyc.com/gbfs/en/station_information.json";
        const statusUrl = "https://gbfs.citibikenyc.com/gbfs/en/station_status.json";

        const [infoResp, statusResp] = await Promise.all([
        fetch(infoUrl),
        fetch(statusUrl)
        ]);

        const infoData = await infoResp.json();
        const statusData = await statusResp.json();

        // Map station_id â†’ status
        const statusMap = {};
        statusData.data.stations.forEach(station => {
        statusMap[station.station_id] = station;
        });

        // Add to Cesium
        infoData.data.stations.forEach(station => {
        const status = statusMap[station.station_id];
        const bikesAvailable = status ? status.num_bikes_available : 0;

        viewer.entities.add({
            name: station.name,
            position: Cesium.Cartesian3.fromDegrees(
            station.lon,
            station.lat,
            0
            ),
            billboard: {
            image: "/assets/bike.png",
            scale: 0.05,
            verticalOrigin: Cesium.VerticalOrigin.BOTTOM
            },
            description: `
            <h3>${station.name}</h3>
            <p><b>Bikes available:</b> ${bikesAvailable}</p>
            <p><b>Docks available:</b> ${status ? status.num_docks_available : "?"}</p>
            `
        });
        });

    } catch (err) {
        console.error("Failed to load CitiBike data:", err);
    }
    }

    
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI0ZDY3MzdiNC04NjYyLTQzYjEtOWRjNy1iMDdkZWVjOTRiMmUiLCJpZCI6MzQ0MzU0LCJpYXQiOjE3NTg3NTQ4MDV9.H4a6uyhj5S0SLWnWe86Z-bCLP95tCPUWeRMsCV5l7K0';

    // Initialize the Cesium Viewer in the HTML element with the `cesiumContainer` ID.
    const viewer = new Cesium.Viewer('cesiumContainer', {
      terrain: Cesium.Terrain.fromWorldTerrain(),
    });    

    // Fly the camera to Lower Manhattan at the given longitude, latitude, and height.
    viewer.camera.flyTo({
    destination: Cesium.Cartesian3.fromDegrees(-74.0419, 40.6841, 2000),
    orientation: {
        heading: Cesium.Math.toRadians(45.0),
        pitch: Cesium.Math.toRadians(-35.0),
    }
    });

    // Add Cesium OSM Buildings, a global 3D buildings layer.
    const buildingTileset = await Cesium.createOsmBuildingsAsync();
    viewer.scene.primitives.add(buildingTileset);   

    // Add Downtown Manhattan Buildings
    const manhattanTileset = await Cesium.Cesium3DTileset.fromIonAssetId(3806843);
    viewer.scene.primitives.add(manhattanTileset);

    // Add Downtown Manhattan polygon
    const manhattanFP = await Cesium.IonResource.fromAssetId(3807170);
    const fpSource = await Cesium.GeoJsonDataSource.load(manhattanFP, {
    clampToGround: true,
  });
    viewer.dataSources.add(fpSource);

    const footprint = fpSource.entities.values.find((entity) =>
    Cesium.defined(entity.polygon)
    );
    footprint.polygon.outline = false;

    // Hide footprint
    footprint.show = false;

    // Add clipping polygons based on the loaded footprint polygon
    const positions = footprint.polygon.hierarchy.getValue().positions;
    const clippingPolygons = new Cesium.ClippingPolygonCollection({
    polygons: [
        new Cesium.ClippingPolygon({
        positions: positions,
        }),
    ],
    });

    // Add the clipping polygon collection to the global tileset
    buildingTileset.clippingPolygons = clippingPolygons;
    
    // Add bike stations to viewer
    loadCitiBikeStations(viewer);

  </script>
 </div>
</body>
</html>
